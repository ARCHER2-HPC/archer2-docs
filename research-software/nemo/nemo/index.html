
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>NEMO - ARCHER2 User Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../stylesheets/archer2.css">
    
    
      
  



  
  



  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-165933823-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nemo" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="ARCHER2 User Documentation" class="md-header__button md-logo" aria-label="ARCHER2 User Documentation" data-md-component="logo">
      
  <img src="../../../images/archer2_white_transparent.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ARCHER2 User Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              NEMO
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/ARCHER2-HPC/archer2-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ARCHER2-HPC/archer2-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ARCHER2 User Documentation" class="md-nav__button md-logo" aria-label="ARCHER2 User Documentation" data-md-component="logo">
      
  <img src="../../../images/archer2_white_transparent.png" alt="logo">

    </a>
    ARCHER2 User Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ARCHER2-HPC/archer2-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ARCHER2-HPC/archer2-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Documentation overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Quickstart
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Quickstart" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Quickstart
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick-start/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick-start/quickstart-users/" class="md-nav__link">
        Quickstart for users
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick-start/quickstart-developers/" class="md-nav__link">
        Quickstart for developers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../known-issues/" class="md-nav__link">
        ARCHER2 Known Issues
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../faq/" class="md-nav__link">
        ARCHER2 Frequently Asked Questions
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          User and Best Practice Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User and Best Practice Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          User and Best Practice Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/hardware/" class="md-nav__link">
        Hardware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/connecting/" class="md-nav__link">
        Connecting to ARCHER2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/data/" class="md-nav__link">
        Data management and transfer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/sw-environment/" class="md-nav__link">
        Software environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/scheduler/" class="md-nav__link">
        Running jobs on ARCHER2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/io/" class="md-nav__link">
        I/O and file systems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/dev-environment/" class="md-nav__link">
        Application development environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/containers/" class="md-nav__link">
        Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/python/" class="md-nav__link">
        Using Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/analysis/" class="md-nav__link">
        Data analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/debug/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/profile/" class="md-nav__link">
        Profiling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/tuning/" class="md-nav__link">
        Performance tuning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide/hardware/" class="md-nav__link">
        Hardware
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Research Software
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Research Software" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Research Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../castep/castep/" class="md-nav__link">
        CASTEP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chemshell/chemshell/" class="md-nav__link">
        Chemshell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../code-saturne/code-saturne/" class="md-nav__link">
        Code_Saturne
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cp2k/cp2k/" class="md-nav__link">
        CP2K
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../elk/elk/" class="md-nav__link">
        ELK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../fenics/fenics/" class="md-nav__link">
        FEniCS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gromacs/gromacs/" class="md-nav__link">
        GROMACS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lammps/lammps/" class="md-nav__link">
        LAMMPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mitgcm/mitgcm/" class="md-nav__link">
        MITgcm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mo-unified-model/mo-unified-model/" class="md-nav__link">
        Met Office Unified Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../namd/namd/" class="md-nav__link">
        NAMD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nektarplusplus/nektarplusplus/" class="md-nav__link">
        Nektar++
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          NEMO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        NEMO
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#useful-links" class="md-nav__link">
    Useful Links
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-nemo-on-archer2" class="md-nav__link">
    Using NEMO on ARCHER2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-correct-environment" class="md-nav__link">
    Setting up the correct environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enabling-fcm-to-compile-in-parallel-with-cray-compilers" class="md-nav__link">
    Enabling FCM to compile in parallel with Cray compilers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-xios-and-nemo" class="md-nav__link">
    Compiling XIOS and NEMO
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-run-script" class="md-nav__link">
    Building a run script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-mkslurm-script" class="md-nav__link">
    The mkslurm script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-parallel-nemo-jobs" class="md-nav__link">
    Running parallel NEMO jobs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-preliminary-tests" class="md-nav__link">
    Some preliminary tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternative-placement-strategies" class="md-nav__link">
    Alternative placement strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests-with-alternative-packing-strategies" class="md-nav__link">
    Tests with alternative packing strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-heterogeneous-jobs" class="md-nav__link">
    Running heterogeneous jobs
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nwchem/nwchem/" class="md-nav__link">
        NWChem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../onetep/onetep/" class="md-nav__link">
        ONETEP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openfoam/openfoam/" class="md-nav__link">
        OpenFOAM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../qe/qe/" class="md-nav__link">
        Quantum Espresso
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vasp/vasp/" class="md-nav__link">
        VASP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Software Libraries
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Software Libraries" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Software Libraries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/libsci/" class="md-nav__link">
        HPE Cray LibSci: BLAS, LAPACK, ScaLAPACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/fftw/" class="md-nav__link">
        FFTW
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/hdf5/" class="md-nav__link">
        HDF5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/netcdf/" class="md-nav__link">
        NetCDF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/adios/" class="md-nav__link">
        ADIOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/boost/" class="md-nav__link">
        Boost
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/glm/" class="md-nav__link">
        GLM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/hypre/" class="md-nav__link">
        HYPRE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/matio/" class="md-nav__link">
        Matio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/mkl/" class="md-nav__link">
        Intel MKL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/mumps/" class="md-nav__link">
        MUMPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/petsc/" class="md-nav__link">
        PETSc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/metis/" class="md-nav__link">
        Metis/Parmetis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/scotch/" class="md-nav__link">
        Scotch/PT-Scotch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/slepc/" class="md-nav__link">
        SLEPc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/superlu/" class="md-nav__link">
        SuperLU/SuperLU_DIST
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../software-libraries/trilinos/" class="md-nav__link">
        Trilinos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Data Analysis and Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Data Analysis and Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Data Analysis and Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-tools/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-tools/paraview/" class="md-nav__link">
        ParaView
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-tools/cray-r/" class="md-nav__link">
        R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../data-tools/visidata/" class="md-nav__link">
        VisiData
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../essentials/" class="md-nav__link">
        Essential Skills
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Other Software
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Other Software" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Other Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../other-software/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../other-software/crystal/" class="md-nav__link">
        CRYSTAL
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#useful-links" class="md-nav__link">
    Useful Links
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-nemo-on-archer2" class="md-nav__link">
    Using NEMO on ARCHER2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-correct-environment" class="md-nav__link">
    Setting up the correct environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enabling-fcm-to-compile-in-parallel-with-cray-compilers" class="md-nav__link">
    Enabling FCM to compile in parallel with Cray compilers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiling-xios-and-nemo" class="md-nav__link">
    Compiling XIOS and NEMO
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-run-script" class="md-nav__link">
    Building a run script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-mkslurm-script" class="md-nav__link">
    The mkslurm script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-parallel-nemo-jobs" class="md-nav__link">
    Running parallel NEMO jobs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-preliminary-tests" class="md-nav__link">
    Some preliminary tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternative-placement-strategies" class="md-nav__link">
    Alternative placement strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests-with-alternative-packing-strategies" class="md-nav__link">
    Tests with alternative packing strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-heterogeneous-jobs" class="md-nav__link">
    Running heterogeneous jobs
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ARCHER2-HPC/archer2-docs/edit/main/docs/research-software/nemo/nemo.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="nemo">NEMO</h1>
<p>NEMO (Nucleus for European Modelling of the Ocean) is a state-of-the-art
framework for research activities and forecasting services in ocean and
climate sciences, developed in a sustainable way by a European
consortium.</p>
<h2 id="useful-links">Useful Links</h2>
<ul>
<li>The NEMO home page <a href="https://www.nemo-ocean.eu">https://www.nemo-ocean.eu</a></li>
<li>NEMO documentation
    <a href="https://forge.ipsl.jussieu.fr/nemo/chrome/site/doc/NEMO/guide/html/NEMO_guide.html">https://forge.ipsl.jussieu.fr/nemo/chrome/site/doc/NEMO/guide/html/NEMO_guide.html</a></li>
<li>NEMO users' area <a href="http://forge.ipsl.jussieu.fr/nemo/wiki/Users">http://forge.ipsl.jussieu.fr/nemo/wiki/Users</a> which includes information on
    obtaining and downloading the latest source code releases. </li>
</ul>
<p>NEMO is released under a CeCILL license and if freely available to all
users on ARCHER2.</p>
<h2 id="using-nemo-on-archer2">Using NEMO on ARCHER2</h2>
<p>A central install of NEMO is not appropriate for most users of ARCHER2 since
many configurations will want to add bespoke code changes. There is, however, a
case for providing some central material specific to ARCHER2. This includes:
arch files for compiling on ARCHER2; a pre-compiled version of XIOS and guides
for running NEMO on ARCHER2. The guides provided here address the running of
NEMO as a stand-alone ocean model (albeit with optional sea-ice and external
XIOS i/o servers ) and provide links to some of the material held in the shared
workspace of the n01 (oceans and shelf seas) consortium. The running of full
Earth System Models with NEMO as just one component of a fully interacting,
OASIS-coupled, suite is best dealt with by more comprehensive workflow
management systems such as the Rose and Cylc set-up used by NCAS.</p>
<h2 id="setting-up-the-correct-environment">Setting up the correct environment</h2>
<p>The first point of note is that NEMO will not operate successfully in the
default environment on ARCHER2. To be precise, this statement is true for any
attempts to run NEMO as part of a MPMD task with external XIOS servers. In
attached mode, where no external servers are used and every ocean process acts
as an io server, then the default environment can be used to launch NEMO as a
SPMD task. Since attached mode is not performant at high core counts it is
advisable to standardise on on environment which is suitable for all NEMO
applications. This is currently:</p>
<ul>
<li>Either (starting from the default environment):</li>
</ul>
<p><div class="highlight"><pre><span></span><code>module unload cray-mpich
module load craype-network-ucx
module load cray-mpich-ucx
module load libfabric
module load cray-hdf5-parallel
module load cray-netcdf-hdf5parallel
module load gcc
</code></pre></div>
- Or, equivalently:
<div class="highlight"><pre><span></span><code>module -s restore /work/n01/shared/acc/n01_modules/ucx_env
</code></pre></div></p>
<p>If your NEMO tasks are failing at start-up (or possibly hanging) then the
chances are you are attempting to use the wrong mpich library. Note
all investigations to date have focussed on using the Cray compilers.</p>
<h2 id="enabling-fcm-to-compile-in-parallel-with-cray-compilers">Enabling FCM to compile in parallel with Cray compilers</h2>
<p>FCM is bundled with both NEMO and XIOS and is used by makenemo and make_xios
scripts These scripts accept –j N/-jobs N arguments for parallel builds but the
Cray compilers trip up attempting to load modules which have only just been
built. It seems to be a timing issue because if the -J option is added to inform
the compiler where to look for modules the problem disappears. The -J option
should not be necessary because the -I setting is already given and, according to
the manual, directories given by -J are searched first followed by those given by
-I. The slight difference in priority seems to matter though and parallel builds
will fail with the Cray compilers unless the following change is made to:</p>
<div class="highlight"><pre><span></span><code>NEMO/r4.0.X/ext/FCM/lib/Fcm/Config.pm   (NEMO4 source tree) 
</code></pre></div>
<p>and (if compiling xios, not everyone needs to do this, see next section)</p>
<div class="highlight"><pre><span></span><code>xios-2.5/tools/FCM/lib/Fcm/Config.pm   (may need to run make_xios once to unpack this)
</code></pre></div>
<p>In both cases change: </p>
<div class="highlight"><pre><span></span><code>FC_MODSEARCH =&gt; &#39;&#39;,             # FC flag, specify &quot;module&quot; path
to
FC_MODSEARCH =&gt; &#39;-J&#39;,           # FC flag, specify &quot;module&quot; path
</code></pre></div>
<h2 id="compiling-xios-and-nemo">Compiling XIOS and NEMO</h2>
<p>It is not necessary for everyone to compile XIOS. A compiled version is available in:
<div class="highlight"><pre><span></span><code>/work/n01/shared/acc/xios-2.5
</code></pre></div>
This was compiled with:
<div class="highlight"><pre><span></span><code>./make_xios --prod --arch X86_ARCHER2-Cray --netcdf_lib netcdf4_par --job 16 --full
</code></pre></div>
using the:
<div class="highlight"><pre><span></span><code>/work/n01/shared/acc/xios-2.5/arch/arch-X86_ARCHER2-Cray.[env,fcm,path] settings
</code></pre></div></p>
<p>The NEMO arch file suggested at the next step will link nemo with the xios libraries
contained therein and copies of the xios_server.exe executable can be taken from
the xios-2.5/bin directory. It is recommended to take copies of this executable
to guard against any possible issues with future updates.</p>
<p>NEMO can be compiled with (for example):</p>
<p><div class="highlight"><pre><span></span><code>./makenemo -n ORCA2_ICE_PISCES_ST -r ORCA2_ICE_PISCES  -m X86_ARCHER2-Cray -j 16
</code></pre></div>
once the:
<div class="highlight"><pre><span></span><code>/work/n01/shared/acc/arch-X86_ARCHER2-Cray.fcm
</code></pre></div>
file has been dropped into the NEMO arch directory. Note this arch file 
currently sets compiler flags of:
<div class="highlight"><pre><span></span><code>-em -s integer32 -s real64 -O1 -hflex_mp=intolerant
</code></pre></div></p>
<p>Small gains at higher optimisation levels are offset by much longer compile
times and an inability to attain restartability and reproducibility passes in
some of the standard SETTE tests. Future releases of NEMO (post r4.0.4) will
contain this arch file for ARCHER2. Users of versions 4.0.4 and earlier will
have to manually add this file.</p>
<h2 id="building-a-run-script">Building a run script</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following 5 sections describe an evolving approach to running NEMO
on ARCHER2 that culminated in the recommended method described in the last
section: <a href="#running-heterogeneous-jobs">Running heterogeneous jobs</a>. If you
are not interested in the details of how this solution was reached, skip 
straight to that <a href="#running-heterogeneous-jobs">final section</a>.</p>
</div>
<p>Most NEMO applications will want to run in detached mode with separate XIOS
servers.  Remember this is only currently possible using the cray-mpich-ucx
module.  MPMD jobs are more complex to set-up than on ARCHER;  but also more
versatile since executables can be mixed on a node.  Generally, xios_servers
will need to be more lightly packed than NEMO cores because:</p>
<ul>
<li>xios servers have less consistent memory requirements than the ocean cores</li>
<li>They generally require more memory and their needs can spike depending on 
   output interval or experimental needs</li>
<li>There are far fewer of them than ocean cores so a pragmatic solution might be to
   assign each xios_server an entire NUMA region of its own</li>
<li>It also makes sense to avoid concentrating too many xios_servers on any particular node</li>
<li>Very large models may require xios_servers to occupy more than one NUMA (TBD)</li>
</ul>
<p>All this can be achieved using the:
<div class="highlight"><pre><span></span><code> –cpu-bind=map_cpu:&lt;cpu map&gt; 
</code></pre></div>
option to srun but it is tedious to construct cpu maps by hand. 
The:
<div class="highlight"><pre><span></span><code>/work/n01/shared/acc/mkslurm 
</code></pre></div>
script will construct a basic run script using supplied packing arguments.</p>
<h2 id="the-mkslurm-script">The mkslurm script</h2>
<p><div class="highlight"><pre><span></span><code>usage: mkslurm [-S num_servers] [-s server_spacing] [-m max_servers_per_node] 
               [-C num_clients] [-c client_spacing] 
               [-t time_limit] [-a account] [-j job_name]
</code></pre></div>
It is recommended to take your own copy and set defaults for most of these arguments</p>
<p>For example, to run with 4 xios servers (a maximum of 2 per node), each with
sole occupancy of a 16-core NUMA region and 96 ocean cores, spaced with an idle
core in between each, use:
<div class="highlight"><pre><span></span><code>./mkslurm -S 4 -s 16 -m 2 -C 96 -c 2 &gt; myscript.slurm
</code></pre></div>
This will report (to stderr) that 2 nodes are needed with 100 active cores
spread over 256 cores. It will also echo the equivalent full command (to stderr)
to show the defaults used for those arguments not given, i.e.:
<div class="highlight"><pre><span></span><code>Running: mkslurm -S 4 -s 16 -m  4 -C  96 -c  2 -t 00:10:00 -a n01 -j nemo_test
nodes needed= 2 (256)
cores to be used= 100 (256)
</code></pre></div>
The slurm script produced is shown in the next section</p>
<h2 id="running-parallel-nemo-jobs">Running parallel NEMO jobs</h2>
<p>The script produced is:
<div class="highlight"><pre><span></span><code>#!/bin/bash
#SBATCH --job-name=nemo_test
#SBATCH --time=00:10:00
#SBATCH --nodes=2
#SBATCH --ntasks=100
#SBATCH --account=n01
#SBATCH --partition=standard
#SBATCH --qos=standard
export OMP_NUM_THREADS=1
module restore /work/n01/shared/acc/n01_modules/ucx_env
#
cat &gt; myscript_wrapper2.sh &lt;&lt; EOFB
#!/bin/ksh
#
set -A map ./xios_server.exe ./nemo
exec_map=( 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 )
#
exec \${map[\${exec_map[\$SLURM_PROCID]}]}
##
EOFB
chmod u+x ./myscript_wrapper2.sh
#
srun --mem-bind=local --cpu-bind=v,map_cpu:00,0x10,0x20,0x22,0x24,0x26,0x28,0x2a,0x2c,0x2e,0x30,0x32,0x34,0x36,0x38,0x3a,0x3c,0x3e,0x40,0x42,0x44,0x46,0x48,0x4a,0x4c,0x4e,0x50,0x52,0x54,0x56,0x58,0x5a,0x5c,0x5e,0x60,0x62,0x64,0x66,0x68,0x6a,0x6c,0x6e,0x70,0x72,0x74,0x76,0x78,0x7a,0x7c,0x7e,00,0x10,0x20,0x22,0x24,0x26,0x28,0x2a,0x2c,0x2e,0x30,0x32,0x34,0x36,0x38,0x3a,0x3c,0x3e,0x40,0x42,0x44,0x46,0x48,0x4a,0x4c,0x4e,0x50,0x52,0x54,0x56,0x58,0x5a,0x5c,0x5e,0x60,0x62,0x64,0x66,0x68,0x6a,0x6c,0x6e,0x70,0x72,0x74,0x76,0x78,0x7a,0x7c,0x7e, ./myscript_wrapper2.sh
</code></pre></div></p>
<p>which will run the desired MPMD job providing the xios_server.exe and nemo
executables are in the directory that this script is submitted from. The
exec_map array shows the position of each executable in the rank list
(0=xios_server.exe, 1=nemo). The cpu map gives the hexadecimal number of the
core that will run that executable. For larger core counts the cpu_map can be
limited to a single node map which will be cycled through as many times as
necessary until all the tasks are mapped.</p>
<h2 id="some-preliminary-tests">Some preliminary tests</h2>
<p>This table shows the results of a repeated 60 day simulation of the
ORCA2_ICE_PISCES, SETTE configuration using various core counts and packing
strategies:</p>
<p><img alt="Screenshot" src="../orca2_tests.png" /></p>
<h2 id="alternative-placement-strategies">Alternative placement strategies</h2>
<p>It is clear from the previous results that fully populating an ARCHER2 node is
unlikely to provide the optimal performance for any codes with moderate memory
bandwidth requirements. The regular packing strategy offered by mkslurm does not
allow experimentation with less wasteful packing strategies than half-population
though.</p>
<p>There may be a case, for example, for just leaving every 1 in 4 cores idle, or
every 1 in 8, or even fewer idle cores per node.  The mkslurm_alt script
(/work/n01/shared/acc/mkslurm_alt) provides a method of generating cpu-bind maps
for exploring these strategies.</p>
<p>The script assumes no change in the packing strategy for the servers but the
core spacing argument (-c) for the ocean cores is replaced by a -g option
representing the frequency of a gap in the, otherwise tightly-packed, ocean
cores. A -v option has also been introduced to provide a human-readable
indication of the core usage. I.e.:</p>
<div class="highlight"><pre><span></span><code>usage:  mkslurm_alt [-S num_servers] [-s server_spacing] [-m max_servers_per_node] 
                    [-C num_clients] [-g client_gap_interval] [-t time_limit] 
                    [-a account] [-j job_name] [-v]
</code></pre></div>
<p><img alt="Screenshot" src="../gap_options.png" /></p>
<h2 id="tests-with-alternative-packing-strategies">Tests with alternative packing strategies</h2>
<p>Preliminary tests have been conducted with the ORCA2_ICE_PISCES SETTE test case.
This is a relatively small test case that will fit onto  single node. It is also
small enough to perform well in attached mode. First some baseline tests in
attached mode. For 32 and 64 core tests, these are equivalent to running a
mkslurm-generated script with -S 0 and -C 32 -c 4 and -C 64 -c 2, respectively:</p>
<p><img alt="Screenshot" src="../attached_baseline.png" /></p>
<p>Previous tests used 4 I/O servers each occupying a single NUMA. For this size
model, 2 servers occupying half a NUMA each will suffice.  That leaves 112 cores
with which to try different packing strategies.</p>
<p>Is it possible to match or better this elapsed time on a single node including
external I/O servers?  -Yes!  -but not with an obvious gap frequency:</p>
<p><img alt="Screenshot" src="../alt_packing_tests.png" /></p>
<p>And activating land suppression can reduce times further: </p>
<p><img alt="Screenshot" src="../land_suppression_tests.png" /></p>
<p>The optimal two-node solution is also shown (this is quicker but the one node
solution is cheaper).</p>
<h2 id="running-heterogeneous-jobs">Running heterogeneous jobs</h2>
<p>There is a critical limitation to the techniques described so far for placing
tasks on the ARCHER2 nodes. That is that the cpu map generated by the mkslurm
and mkslurm_alt scripts is only applied as expected if the layout is identical
on every node. In general, this is not the case for larger NEMO configurations
because:</p>
<ul>
<li>We may only want server processes (possibly mixed with ocean processes) on an initial subset of nodes</li>
<li>followed by a set of fully utilised (albeit, possibly,  with regular gaps) nodes of only ocean processes</li>
<li>followed (possibly) by a final node with fewer ocean processes</li>
</ul>
<p>To exercise precise control over the placement in each of these parts will
require different cpu maps or masks. This can be achieved by configuring each
part as a component of a heterogeneous job-pack. The basic principle is
explained here:
<a href="https://docs.archer2.ac.uk/user-guide/scheduler/#heterogeneous-jobs-for-a-shared-mpi_com_world">Heterogeneous jobs</a></p>
<p>A python-based extension of the mkslurm_alt functionality has been provided to
automatically generate such job-scripts. The script is located here:</p>
<p><div class="highlight"><pre><span></span><code>/work/n01/shared/malmans/mkslurm_hetjob
</code></pre></div>
The script generates a 'job-pack' (heterogeneous job in modern Slurm parlance)
of up to three parts, corresponding to the possible three components and
generates the correct cpu placement for each part. The jobs have separate
entries in the queue but can only be run or cancelled as a pack and all run
within the same MPI communicator when they start.</p>
<p>Arguments to the script match those of mkslurm_alt, i.e.:</p>
<div class="highlight"><pre><span></span><code>usage: mkslurm_hetjob [-h] [-S S] [-s S] [-m M] [-C C] [-g G] [-N N] [-t T]
                      [-a A] [-j J] [-v]

Python version of mkslurm_alt using HetJob. Server placement
and spacing remains as mkslurm but clients are always tightly packed with a
gap left every &quot;NC_GAP&quot; cores where NC_GAP can be given by the -g argument.
values of 4, 8 or 16 are recommended.

optional arguments:
  -h, --help  show this help message and exit
  -S S        num_servers (default: 4)
  -s S        server_spacing (default: 8)
  -m M        max_servers_per_node (default: 2)
  -C C        num_clients (default: 28)
  -g G        client_gap_interval (default: 4)
  -N N        ncores_per_node (default: 128)
  -t T        time_limit (default: 00:10:00)
  -a A        account (default: n01)
  -j J        job_name (default: nemo_test)
  -v          show human readable hetjobs (default: False)
</code></pre></div>
<p>The use of this script to generate job scripts for most nemo, ocean-only runs is
recommended. Note a tightly-packed placement with no gaps amongst the ocean
processes can be generated using a client gap interval greater than the number
of clients. This script has been used to explore the different placement
strategies with a larger configuration based on eORCA025. In all cases, 8 XIOS
servers were used, each with sole occupancy of a 16-core NUMA and a maximum of 2
servers per node. The rest of the initial 4 nodes (and any subsequent ocean
core-only nodes) were filled with ocean cores at various packing densities (from
tightly packed to half-populated). A summary of the results are shown below.</p>
<p><img alt="Screenshot" src="../eORCA025_tests.png" /></p>
<p>The limit of scalability for this problem size lies around 1500 cores. One
interesting aspect is that the cost, in terms of node hours, remains fairly flat
up to a thousand processes and the choice of gap placement makes much less
difference as the individual domains shrink. It looks as if, so long as you
avoid inappropriately high numbers of processors, choosing the wrong placement
won't waste your allocation but may waste your time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This information is based on experience during early user testing and
is subject to change</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../../nektarplusplus/nektarplusplus/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Nektar++" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Nektar++
            </div>
          </div>
        </a>
      
      
        
        <a href="../../nwchem/nwchem/" class="md-footer__link md-footer__link--next" aria-label="Next: NWChem" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              NWChem
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/ARCHER2-HPC" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/ARCHER2_HPC" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.linkedin.com/groups/13848871/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>