
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.1">
    
    
      
        <title>Containers - ARCHER2 User Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e8d9bf0c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/archer2.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#containers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ARCHER2 User Documentation" class="md-header__button md-logo" aria-label="ARCHER2 User Documentation" data-md-component="logo">
      
  <img src="../../images/archer2_white_transparent.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ARCHER2 User Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Containers
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ARCHER2-HPC/archer2-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ARCHER2-HPC/archer2-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ARCHER2 User Documentation" class="md-nav__button md-logo" aria-label="ARCHER2 User Documentation" data-md-component="logo">
      
  <img src="../../images/archer2_white_transparent.png" alt="logo">

    </a>
    ARCHER2 User Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ARCHER2-HPC/archer2-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ARCHER2-HPC/archer2-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Documentation overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Quickstart
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Quickstart" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Quickstart
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/quickstart-users/" class="md-nav__link">
        Quickstart for users
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/quickstart-developers/" class="md-nav__link">
        Quickstart for developers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../known-issues/" class="md-nav__link">
        ARCHER2 Known Issues
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        ARCHER2 Frequently Asked Questions
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          User and Best Practice Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User and Best Practice Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          User and Best Practice Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        Hardware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../connecting/" class="md-nav__link">
        Connecting to ARCHER2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Data management and transfer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sw-environment/" class="md-nav__link">
        Software environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scheduler/" class="md-nav__link">
        Running jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        I/O and file systems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dev-environment/" class="md-nav__link">
        Application development environment
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Containers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Containers
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#useful-links" class="md-nav__link">
    Useful Links
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-singularity-containers-images" class="md-nav__link">
    About Singularity Containers (Images)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-singularity-images-on-archer2" class="md-nav__link">
    Using Singularity Images on ARCHER2
  </a>
  
    <nav class="md-nav" aria-label="Using Singularity Images on ARCHER2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-existing-images-onto-archer2" class="md-nav__link">
    Getting existing images onto ARCHER2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-use-on-the-login-nodes" class="md-nav__link">
    Interactive use on the login nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-use-on-the-compute-nodes" class="md-nav__link">
    Interactive use on the compute nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial-processes-within-a-non-interactive-batch-script" class="md-nav__link">
    Serial processes within a non-interactive batch script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-processes-within-a-non-interactive-batch-script" class="md-nav__link">
    Parallel processes within a non-interactive batch script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-your-own-singularity-images" class="md-nav__link">
    Creating Your Own Singularity Images
  </a>
  
    <nav class="md-nav" aria-label="Creating Your Own Singularity Images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-singularity-images-using-docker-macoswindows" class="md-nav__link">
    Building Singularity images using Docker (macOS/Windows)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-singularity-with-mpi-on-archer2" class="md-nav__link">
    Using Singularity with MPI on ARCHER2
  </a>
  
    <nav class="md-nav" aria-label="Using Singularity with MPI on ARCHER2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-an-image-with-mpi-from-scratch" class="md-nav__link">
    Building an image with MPI from scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-an-image-based-on-the-base-archer2-mpi-singularity-image" class="md-nav__link">
    Creating an image based on the base ARCHER2 MPI Singularity image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-parallel-mpi-jobs-using-singularity-containers" class="md-nav__link">
    Running parallel MPI jobs using Singularity containers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        Using Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        Data analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debug/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../profile/" class="md-nav__link">
        Profiling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tuning/" class="md-nav__link">
        Performance tuning
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Research Software
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Research Software" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Research Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/castep/castep/" class="md-nav__link">
        CASTEP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/chemshell/chemshell/" class="md-nav__link">
        Chemshell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/code-saturne/code-saturne/" class="md-nav__link">
        Code_Saturne
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/cp2k/cp2k/" class="md-nav__link">
        CP2K
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/elk/elk/" class="md-nav__link">
        ELK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/fenics/fenics/" class="md-nav__link">
        FEniCS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/gromacs/gromacs/" class="md-nav__link">
        GROMACS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/lammps/lammps/" class="md-nav__link">
        LAMMPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/mitgcm/mitgcm/" class="md-nav__link">
        MITgcm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/mo-unified-model/mo-unified-model/" class="md-nav__link">
        Met Office Unified Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/namd/namd/" class="md-nav__link">
        NAMD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/nektarplusplus/nektarplusplus/" class="md-nav__link">
        Nektar++
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/nemo/nemo/" class="md-nav__link">
        NEMO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/nwchem/nwchem/" class="md-nav__link">
        NWChem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/onetep/onetep/" class="md-nav__link">
        ONETEP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/openfoam/openfoam/" class="md-nav__link">
        OpenFOAM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/qe/qe/" class="md-nav__link">
        Quantum Espresso
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/vasp/vasp/" class="md-nav__link">
        VASP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Software Libraries
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Software Libraries" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Software Libraries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/libsci/" class="md-nav__link">
        HPE Cray LibSci: BLAS, LAPACK, ScaLAPACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/fftw/" class="md-nav__link">
        FFTW
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/hdf5/" class="md-nav__link">
        HDF5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/netcdf/" class="md-nav__link">
        NetCDF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/adios/" class="md-nav__link">
        ADIOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/arpack/" class="md-nav__link">
        ARPACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/boost/" class="md-nav__link">
        Boost
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/eigen/" class="md-nav__link">
        Eigen
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/glm/" class="md-nav__link">
        GLM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/hypre/" class="md-nav__link">
        HYPRE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/matio/" class="md-nav__link">
        Matio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/mkl/" class="md-nav__link">
        Intel MKL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/mumps/" class="md-nav__link">
        MUMPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/petsc/" class="md-nav__link">
        PETSc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/metis/" class="md-nav__link">
        Metis/Parmetis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/scotch/" class="md-nav__link">
        Scotch/PT-Scotch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/slepc/" class="md-nav__link">
        SLEPc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/superlu/" class="md-nav__link">
        SuperLU/SuperLU_DIST
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/trilinos/" class="md-nav__link">
        Trilinos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Data Analysis and Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Data Analysis and Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Data Analysis and Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/paraview/" class="md-nav__link">
        ParaView
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/cray-r/" class="md-nav__link">
        R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/visidata/" class="md-nav__link">
        VisiData
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Other Software
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Other Software" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Other Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../other-software/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../other-software/crystal/" class="md-nav__link">
        CRYSTAL
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../essentials/" class="md-nav__link">
        Essential Skills
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../publish/" class="md-nav__link">
        ARCHER2 and Publications
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#useful-links" class="md-nav__link">
    Useful Links
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-singularity-containers-images" class="md-nav__link">
    About Singularity Containers (Images)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-singularity-images-on-archer2" class="md-nav__link">
    Using Singularity Images on ARCHER2
  </a>
  
    <nav class="md-nav" aria-label="Using Singularity Images on ARCHER2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-existing-images-onto-archer2" class="md-nav__link">
    Getting existing images onto ARCHER2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-use-on-the-login-nodes" class="md-nav__link">
    Interactive use on the login nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interactive-use-on-the-compute-nodes" class="md-nav__link">
    Interactive use on the compute nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial-processes-within-a-non-interactive-batch-script" class="md-nav__link">
    Serial processes within a non-interactive batch script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-processes-within-a-non-interactive-batch-script" class="md-nav__link">
    Parallel processes within a non-interactive batch script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-your-own-singularity-images" class="md-nav__link">
    Creating Your Own Singularity Images
  </a>
  
    <nav class="md-nav" aria-label="Creating Your Own Singularity Images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-singularity-images-using-docker-macoswindows" class="md-nav__link">
    Building Singularity images using Docker (macOS/Windows)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-singularity-with-mpi-on-archer2" class="md-nav__link">
    Using Singularity with MPI on ARCHER2
  </a>
  
    <nav class="md-nav" aria-label="Using Singularity with MPI on ARCHER2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-an-image-with-mpi-from-scratch" class="md-nav__link">
    Building an image with MPI from scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-an-image-based-on-the-base-archer2-mpi-singularity-image" class="md-nav__link">
    Creating an image based on the base ARCHER2 MPI Singularity image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-parallel-mpi-jobs-using-singularity-containers" class="md-nav__link">
    Running parallel MPI jobs using Singularity containers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/ARCHER2-HPC/archer2-docs/edit/main/docs/user-guide/containers.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>



<h1 id="containers">Containers</h1>
<p>This page was originally based on the documentation at the
<a href="http://docs.hpc.shef.ac.uk/en/latest/sharc/software/apps/singularity.html">University of Sheffield HPC service</a></p>
<p>Designed around the notion of mobility of compute and reproducible
science, Singularity enables users to have full control of their
operating system environment. This means that a non-privileged user can
"swap out" the Linux operating system and environment on the host for a
Linux OS and environment that they control. So if the host system is
running CentOS Linux but your application runs in Ubuntu Linux with a
particular software stack, you can create an Ubuntu image, install your
software into that image, copy the image to another host (e.g. ARCHER2),
and run your application on that host in its native Ubuntu environment.</p>
<p>Singularity also allows you to leverage the resources of whatever host
you are on. This includes high-speed interconnects (e.g. Slingshot on
ARCHER2), file systems (e.g. /home and /work on ARCHER2) and potentially other
resources.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Singularity only supports Linux containers. You cannot create
images that use Windows or macOS (this is a restriction of the
containerisation model rather than Singularity).</p>
</div>
<h2 id="useful-links">Useful Links</h2>
<ul>
<li><a href="https://www.sylabs.io/">Singularity website</a></li>
<li><a href="https://www.sylabs.io/docs/">Singularity documentation</a></li>
</ul>
<h2 id="about-singularity-containers-images">About Singularity Containers (Images)</h2>
<p>Similar to Docker, a Singularity container (or, more commonly, <em>image</em>)
is a self-contained software stack. As Singularity does not require a
root-level daemon to run its images (as is required by Docker) it is
suitable for use on multi-user HPC systems such as ARCHER2. Within the
container/image, you have exactly the same permissions as you do in a
standard login session on the system.</p>
<p>In practice, this means that an image created on your local machine with
all your research software installed for local development will also run
on ARCHER2.</p>
<p>Pre-built images (such as those on <a href="http://hub.docker.com">DockerHub</a> or
<a href="https://datasets.datalad.org/?dir=/shub/">SingularityHub archive</a> can simply be downloaded
and used on ARCHER2 (or anywhere else Singularity is installed).</p>
<p>Creating and modifying images requires root permission and so must be
done on a system where you have such access (in practice, this is
usually within a virtual machine on your laptop/workstation).</p>
<div class="admonition note singularityhub now read-only">
<p class="admonition-title">Note</p>
<p>SingularityHub was a publicly available cloud service for Singularity Containers active from 2016 to 2021. It built container recipes from Github repositories on Google Cloud, and containers were available via the command line Singularity or sregistry software. These containers are still available now in the <a href="https://datasets.datalad.org/?dir=/shub/">SingularityHub Archive</a></p>
</div>
<h2 id="using-singularity-images-on-archer2">Using Singularity Images on ARCHER2</h2>
<p>Singularity images can be used on ARCHER2 in a number of ways,
including:</p>
<ul>
<li>Interactively on the login nodes</li>
<li>Interactively on compute nodes</li>
<li>As serial processes within a non-interactive batch script</li>
<li>As parallel processes within a non-interactive batch script</li>
</ul>
<p>We provide information on each of these scenarios below. First,
we describe briefly how to get existing images onto ARCHER2 so
that you can use them.</p>
<h3 id="getting-existing-images-onto-archer2">Getting existing images onto ARCHER2</h3>
<p>Singularity images are files, so, if you already have an image,
you can use <code>scp</code> to copy the file to ARCHER2 as you would with
any other file.</p>
<p>If you wish to get a file from one of the container image repositories
then Singularity allows you to do this from ARCHER2 itself.</p>
<p>For example, to retrieve an image from SingularityHub on ARCHER2 we can
simply issue a Singularity command to pull the image.</p>
<pre><code>auser@ln03:~&gt; singularity pull hello-world.sif shub://vsoch/hello-world
</code></pre>
<p>The image located at the <code>shub</code> URI is written to a Singularity Image
File (SIF) called <code>hello-world.sif</code>.</p>
<h3 id="interactive-use-on-the-login-nodes">Interactive use on the login nodes</h3>
<p>Once you have an image file, using it on the login nodes in an
interactive way is extremely simple: you use the <code>singularity shell</code>
command. Using the image we built in the example above:</p>
<pre><code>auser@ln03:~&gt; singularity shell hello-world.sif
Singularity&gt;
</code></pre>
<p>Within a Singularity image your home directory will be available.</p>
<p>Once you have finished using your image, you can return to the ARCHER2
login node prompt with the <code>exit</code> command:</p>
<pre><code>Singularity&gt; exit
exit
auser@ln03:~&gt;
</code></pre>
<h3 id="interactive-use-on-the-compute-nodes">Interactive use on the compute nodes</h3>
<p>The process for using an image interactively on the compute nodes is
very similar to that for the login nodes. The only difference is that
you first have to submit an interactive serial job (from a location on
<code>/work</code>) in order to get interactive access to the compute node.</p>
<p>For example, to reserve a full node for you to work on interactively you
would use:</p>
<pre><code>auser@ln03:/work/t01/t01/auser&gt; srun --nodes=1 --exclusive --time=00:20:00 \
                                      --account=[budget code] \
                                      --partition=standard --qos=standard \
                                      --pty /bin/bash

...wait until job starts...

auser@nid00001:/work/t01/t01/auser&gt;
</code></pre>
<p>Note that the prompt has changed to show you are on a compute node. Now
you can use the image in the same way as on the login node.</p>
<pre><code>auser@nid00001:/work/t01/t01/auser&gt; singularity shell hello-world.sif
Singularity&gt; exit
exit
auser@nid00001:/work/t01/t01/auser&gt; exit
auser@ln03:/work/t01/t01/auser&gt;
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We used <code>exit</code> to leave the interactive image shell and then
<code>exit</code> again to leave the interactive job on the compute node.</p>
</div>
<h3 id="serial-processes-within-a-non-interactive-batch-script">Serial processes within a non-interactive batch script</h3>
<p>You can also use Singularity images within a non-interactive batch
script as you would any other command. If your image contains a
<em>runscript</em> then you can use <code>singularity run</code> to execute the runscript
in the job. You can also use <code>singularity exec</code> to execute arbitrary
commands (or scripts) within the image.</p>
<p>An example job submission script to run a serial job that executes the
runscript within the <code>hello-world.sif</code> image that we downloaded previously to an
ARCHER2 login node would be as follows.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Full system</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash --login</span>

<span class="c1"># Slurm job options (name, compute nodes, job time)</span>

<span class="c1">#SBATCH --job-name=helloworld</span>
<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --time=00:10:00</span>

<span class="c1">#SBATCH --account=[budget code]</span>
<span class="c1">#SBATCH --partition=standard</span>
<span class="c1">#SBATCH --qos=standard</span>

<span class="c1"># Run the serial executable</span>
singularity run <span class="nv">$SLURM_SUBMIT_DIR</span>/hello-world.sif
</code></pre></div>
</div>
</div>
</div>
<p>You submit this in the usual way and the standard output and error
should be written to <code>slurm-...</code>, where the output filename ends
with the job number.</p>
<h3 id="parallel-processes-within-a-non-interactive-batch-script">Parallel processes within a non-interactive batch script</h3>
<p>Running a Singularity container in parallel across a number of compute nodes requires some
preparation. In general though, Singularity can be run within the parallel job launcher (<code>srun</code>).</p>
<pre><code>srun &lt;options&gt; \
    singularity &lt;options&gt; /path/to/image/file \
        app &lt;options&gt;
</code></pre>
<p>The code snippet above shows the launch command as having three nested parts, <code>srun</code>, the singularity environment
and the containerized application.</p>
<p>The Singularity image must be compatible with the MPI environment on the host; either, the containerized
app has been built against the appropriate MPI libraries or the container itself contains an MPI library
that is compatible with the host MPI. The latter situation is known as the <a href="https://sylabs.io/guides/3.7/user-guide/mpi.html#hybrid-model">hybrid model</a>;
this is the approach taken in the sections that follow.</p>
<h2 id="creating-your-own-singularity-images">Creating Your Own Singularity Images</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This information is based on that in the <a href="https://carpentries-incubator.github.io/singularity-introduction/">Introduction to Singularity</a>
lesson from the <a href="https://carpentries.org/community-lessons/#the-carpentries-incubator">Carpentries Incubator</a>. Citation
J. Cohen and A. Turner. "Reproducible computational environments using containers: Introduction to Singularity". Version 2020.08a, 
August 2020. Carpentries Incubator. https://github.com/carpentries-incubator/singularity-introduction</p>
</div>
<p>As we saw above, you can create Singularity images by importing from
DockerHub or Singularity Hub on ARCHER2 itself. If you wish to create
your own custom image using Singularity then you must install Singularity on a system
where you have root (or administrator) privileges - often your own
laptop or workstation.</p>
<p>There are three different options to install Singularity on your local
system: install Docker and use the <a href="https://quay.io/repository/singularity/singularity?tab=tags">Docker Singularity image</a> to build
Singularity containers, install a virtual machine that you can use to
build Singularity images, or install Singularity on your local system.</p>
<p>For macOS and Windows users we recommend installing Docker Desktop and
using the official Singularity image to build your own images. For Linux
users, we recommend installing Singularity directly on your local system.</p>
<p>We cover the mechanism that uses Docker in more detail below for macOS
and Windows users. If your local system is Linux, you can find
information on installing Singularity on Linux distribution at:</p>
<ul>
<li><a href="https://sylabs.io/guides/3.7/admin-guide/installation.html#installation-on-linux">Installing Singularity on
    Linux</a></li>
</ul>
<h3 id="building-singularity-images-using-docker-macoswindows">Building Singularity images using Docker (macOS/Windows)</h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You should install Docker Desktop to allow you to build Singularity
images using Docker. Instructions can be found at:</p>
<ul>
<li><a href="https://docs.docker.com/docker-for-windows/install/">Installing Docker Desktop on Windows Home/Professional</a> </li>
<li><a href="https://docs.docker.com/docker-for-mac/install/">Installing Docker Desktop on macOS</a></li>
</ul>
</div>
<p>Once you have installed Docker, you can build Singularity images with a
command similar to:</p>
<div class="highlight"><pre><span></span><code>docker run -it --privileged --rm -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>:/home/singularity quay.io/singularity/singularity:v3.7.0-slim build /home/singularity/my_image.sif /home/singularity/my_image.def
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can setup an alias to the long <code>docker run</code> command above to make it easier
to use. For example, if you are using bash or zsh you could use a command like
<code>alias dsingularity="docker run -it --privileged --rm -v ${PWD}:/home/singularity quay.io/singularity/singularity:v3.7.0-slim"</code></p>
</div>
<p>For information on how to write Singularity image definition files, see the
<a href="https://sylabs.io/guides/3.7/user-guide/definition_files.html">Singularity documentation</a>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can, of course, also get to a Singularity image via a Docker image
(as Singularity can use images directly from the DockerHub). In this workflow
you would create a Docker image, upload it to the DockerHub and then pull it
using Singularity on ARCHER2.</p>
</div>
<h2 id="using-singularity-with-mpi-on-archer2">Using Singularity with MPI on ARCHER2</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This information is based on that in the <a href="https://carpentries-incubator.github.io/singularity-introduction/">Introduction to Singularity</a>
lesson from the <a href="https://carpentries.org/community-lessons/#the-carpentries-incubator">Carpentries Incubator</a>. Citation
J. Cohen and A. Turner. "Reproducible computational environments using containers: Introduction to Singularity". Version 2020.08a, 
August 2020. Carpentries Incubator. https://github.com/carpentries-incubator/singularity-introduction</p>
</div>
<p>MPI on ARCHER2 is provided by the Cray MPICH libraries with the interface
to the high-performance Slingshot interconnect provided via the OFI interface.
Therefore, as per the <a href="https://sylabs.io/guides/3.7/user-guide/mpi.html#hybrid-model">Singularity MPI Hybrid model</a>, we will build our Singularity image such
that it contains a version of the MPICH MPI library compiled with support for OFI.
Below, we provide instructions on creating a container with
a version of MPICH compiled in this way, but, for convenience, we 
also provide a base image file that already has a suitable MPICH, and so, you
can skip this step if you wish. Instructions on how to use this image as the
base for your own images are also provided. Finally, we provide an 
example of how to run a Singularity container with MPI over multiple 
ARCHER2 compute nodes.</p>
<h3 id="building-an-image-with-mpi-from-scratch">Building an image with MPI from scratch</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These instructions are based on those used in the <a href="https://carpentries-incubator.github.io/singularity-introduction/">Reproducible computational environments using containers: Introduction to Singularity</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Remember, all these steps should be executed on your local system where
you have administrator privileges, <strong>not on ARCHER2</strong>.</p>
</div>
<p>We will illustrate the process of building a Singularity image with MPI from
scratch by building an image that contains MPI provided by MPICH and the OSU
MPI benchmarks. In order to do this, we first need to download the source code
for both MPICH and the OSU benchmarks. At the time of writing, the stable MPICH
release is 3.4.2 and the stable OSU benchmark release is 5.8 - this may have
changed by the time you are following these instructions.</p>
<p>Go ahead and download the source code:</p>
<div class="highlight"><pre><span></span><code>wget http://www.mpich.org/static/downloads/3.4.2/mpich-3.4.2.tar.gz
wget https://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-5.8.tgz
</code></pre></div>
<p>Now create a Singularity image definition file that describes how to build the
image:</p>
<div class="highlight"><pre><span></span><code>Bootstrap: docker
From: ubuntu:20.04

%files
    /home/singularity/osu-micro-benchmarks-5.8.tar.gz /root/
    /home/singularity/mpich-3.4.2.tar.gz /root/

%environment
    export SINGULARITY_MPICH_DIR=/usr

%post
    apt-get -y update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential libfabric-dev libibverbs-dev gfortran
    cd /root
    tar zxvf mpich-3.4.2.tar.gz &amp;&amp; cd mpich-3.4.2
    echo &quot;Configuring and building MPICH...&quot;
    ./configure --prefix=/usr --with-device=ch3:nemesis:ofi &amp;&amp; make -j2 &amp;&amp; make install
    cd /root
    tar zxvf osu-micro-benchmarks-5.8.tar.gz
    cd osu-micro-benchmarks-5.8/
    echo &quot;Configuring and building OSU Micro-Benchmarks...&quot;
    ./configure --prefix=/usr/local/osu CC=/usr/bin/mpicc CXX=/usr/bin/mpicxx
    make -j2 &amp;&amp; make install

%runscript
    exec /usr/local/osu/libexec/osu-micro-benchmarks/mpi/$*
</code></pre></div>
<p>A quick overview of what the above definition file is doing:</p>
<ul>
<li>The image is being bootstrapped from the <code>ubuntu:20.04</code> Docker image.</li>
<li>In the <code>%files</code> section: The OSU Micro-Benchmarks and MPICH tar files are copied from the current directory into the <code>/root</code> directory in the image.</li>
<li>In the <code>%environment</code> section: Set an environment variable that will be available within all containers run from the generated image.</li>
<li>In the <code>%post</code> section:<ul>
<li>Ubuntu's <code>apt-get</code> package manager is used to update the package directory and then install the compilers and other libraries required for the MPICH build.</li>
<li>The MPICH <code>.tar.gz</code> file is extracted and the configure, build and install steps are run. Note the use of the <code>--with-device</code> option to configure MPICH to use the correct driver to support improved communication performance on a high performance cluster.</li>
<li>The OSU Micro-Benchmarks <code>tar.gz</code> file is extracted and the configure, build and install steps are run to build the benchmark code from source.</li>
</ul>
</li>
<li>In the <code>%runscript</code> section: A runscript is set up that will echo the rank number of the current process and then run the command provided as a command line argument.</li>
</ul>
<p><em>Note that the base path of the the executable to run is hardcoded in the run script</em>, so the command line parameter to provide when running a container based on this image is relative to this base path, for example, <code>startup/osu_hello</code>, <code>collective/osu_allgather</code>, <code>pt2pt/osu_latency</code>, <code>one-sided/osu_put_latency</code>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You can find more information on Singularity definition file syntax in the
<a href="https://sylabs.io/guides/3.7/user-guide/definition_files.html">Singularity documentation</a>.</p>
</div>
<p>Now go ahead and build the Singularity image using Singularity via Docker:</p>
<div class="highlight"><pre><span></span><code>docker run -it --privileged --rm -v <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>:/home/singularity quay.io/singularity/singularity:v3.7.0-slim build /home/singularity/osu_benchmarks.sif /home/singularity/osu_benchmarks.def
</code></pre></div>
<p>Once you have successfully created your Singularity image file, <code>osu_benchmarks.sif</code>, use <code>scp</code> to 
copy it to ARCHER2 and you can test as described in the section below.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can setup an alias to the long <code>docker run</code> command above to make it easier
to use. For example, if you are using bash or zsh you could use a command like
<code>alias dsingularity="docker run -it --privileged --rm -v ${PWD}:/home/singularity quay.io/singularity/singularity:v3.7.0-slim"</code></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can find a copy of the <code>osu_benchmarks.sif</code> image on ARCHER2 in the directory
<code>$EPCC_SINGULARITY_DIR</code> if you do not want to build it yourself but still want to
test.</p>
</div>
<h3 id="creating-an-image-based-on-the-base-archer2-mpi-singularity-image">Creating an image based on the base ARCHER2 MPI Singularity image</h3>
<p>We have built an image with MPICH 3.4.1 built against OFI that you can use as a base
image to install further software and create your own images. The image can be found
on ARCHER2 at <code>$EPCC_SINGULARITY_DIR/mpich_base.sif</code>.</p>
<p>To use this image in your own image builds you should download it from ARCHER2 to the
system where you are building your images. You can then add the following lines to 
your image definition file to start from this base image:</p>
<div class="highlight"><pre><span></span><code>Bootstrap: localimage
From: /path/to/container/mpich_base.sif
</code></pre></div>
<p>(Remember to put the actual path to the <code>mpich_base.sif</code> image file that you have
downloaded to your system.)</p>
<h3 id="running-parallel-mpi-jobs-using-singularity-containers">Running parallel MPI jobs using Singularity containers</h3>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>These instructions assume you have a Singularity image uploaded to 
ARCHER2 that includes MPI provided by MPICH with the OFI interface.
See the sections above for how to create such images.</p>
</div>
<p>Once you have uploaded your Singularity image that includes MPICH built with
OFI for ARCHER2, you can use it to run parallel jobs in a similar way to
non-Singularity jobs. The example job submission script below uses the image
we built above with MPICH and the OSU benchmarks to run the Allreduce benchmark
on two nodes where all 128 cores on each node are used for MPI processes (so, 256
MPI processes in total).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Full system</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># Slurm job options (name, compute nodes, job time)</span>
<span class="c1">#SBATCH --job-name=singularity_parallel</span>
<span class="c1">#SBATCH --time=0:10:0</span>
<span class="c1">#SBATCH --nodes=2</span>
<span class="c1">#SBATCH --tasks-per-node=128</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>

<span class="c1"># Replace [budget code] below with your budget code (e.g. t01)</span>
<span class="c1">#SBATCH --partition=standard</span>
<span class="c1">#SBATCH --qos=standard</span>
<span class="c1">#SBATCH --account=[budget code]</span>

<span class="c1"># Set the number of threads to 1.</span>
<span class="c1"># This prevents any threaded system libraries from automatically using threading.</span>
<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Set the LD_LIBRARY_PATH environment variable within the Singularity container</span>
<span class="c1"># to ensure that it used the correct MPI libraries.</span>
<span class="nb">export</span> <span class="nv">SINGULARITYENV_LD_LIBRARY_PATH</span><span class="o">=</span> <span class="se">\</span>
    /opt/cray/pe/mpich/8.1.9/ofi/gnu/9.1/lib-abi-mpich: <span class="se">\</span>
    /opt/cray/pe/pmi/6.0.13/lib: <span class="se">\</span>
    /opt/cray/libfabric/1.11.0.4.71/lib64: <span class="se">\</span>
    /usr/lib64/host: <span class="se">\</span>
    /usr/lib/x86_64-linux-gnu/libibverbs: <span class="se">\</span>
    /.singularity.d/libs

<span class="c1"># Set the options for the Singularity executable.</span>
<span class="c1"># This makes sure Cray Slingshot interconnect libraries are available</span>
<span class="c1"># from inside the container.</span>
<span class="nv">BIND_OPTS</span><span class="o">=</span><span class="s2">&quot;-B /opt/cray,/usr/lib64:/usr/lib64/host,/usr/lib64/tcl&quot;</span>
<span class="nv">BIND_OPTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">BIND_OPTS</span><span class="si">}</span><span class="s2">,/var/spool/slurmd/mpi_cray_shasta&quot;</span>

<span class="c1"># Launch the parallel job.</span>
srun --hint<span class="o">=</span>nomultithread --distribution<span class="o">=</span>block:block <span class="se">\</span>
    singularity run <span class="si">${</span><span class="nv">BIND_OPTS</span><span class="si">}</span> osu_benchmarks.sif <span class="se">\</span>
        collective/osu_allreduce
</code></pre></div>
</div>
</div>
</div>
<p>The only changes from a standard submission script are:</p>
<ul>
<li>We set the environment variable <code>SINGULARITY_LD_LIBRARY_PATH</code> to ensure the correct libraries are available within the container to be able to use Cray MPICH.</li>
<li><code>srun</code> calls the <code>singularity</code> software with the image file we created rather than the parallel program directly.</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember that the image file must be located on <code>/work</code> to run jobs on the
compute nodes.</p>
</div>
<p>If the job runs correctly, you should see output similar to the following in your <code>slurm-*.out</code> 
file:</p>
<div class="highlight"><pre><span></span><code># OSU MPI Allreduce Latency Test v5.7
# Size       Avg Latency(us)
4                       6.81
8                       6.86
16                      6.90
32                      7.09
64                     10.79
128                    10.97
256                    13.07
512                    15.50
1024                   17.35
2048                   22.49
4096                   41.13
8192                   54.00
16384                  75.09
32768                 120.40
65536                 243.26
131072                614.60
262144                618.11
524288                877.92
1048576              2981.61
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../dev-environment/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Application development environment" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Application development environment
            </div>
          </div>
        </a>
      
      
        
        <a href="../python/" class="md-footer__link md-footer__link--next" aria-label="Next: Using Python" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Using Python
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/ARCHER2-HPC" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/ARCHER2_HPC" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.linkedin.com/groups/13848871/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.8aa65030.min.js"></script>
      
    
  </body>
</html>