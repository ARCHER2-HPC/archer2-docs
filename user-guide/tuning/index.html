
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../profile/">
      
      
        <link rel="next" href="../energy/">
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.18">
    
    
      
        <title>Performance tuning - ARCHER2 User Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/archer2.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-XVNML97F1T"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-XVNML97F1T",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-XVNML97F1T",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#performance-tuning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ARCHER2 User Documentation" class="md-header__button md-logo" aria-label="ARCHER2 User Documentation" data-md-component="logo">
      
  <img src="../../images/archer2_white_transparent.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ARCHER2 User Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Performance tuning
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ARCHER2-HPC/archer2-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ARCHER2-HPC/archer2-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ARCHER2 User Documentation" class="md-nav__button md-logo" aria-label="ARCHER2 User Documentation" data-md-component="logo">
      
  <img src="../../images/archer2_white_transparent.png" alt="logo">

    </a>
    ARCHER2 User Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ARCHER2-HPC/archer2-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ARCHER2-HPC/archer2-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Documentation overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Quickstart
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Quickstart
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/quickstart-users/" class="md-nav__link">
        Quickstart for users
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/quickstart-developers/" class="md-nav__link">
        Quickstart for developers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/quickstart-next-steps/" class="md-nav__link">
        Quickstart next steps
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../known-issues/" class="md-nav__link">
        ARCHER2 Known Issues
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          ARCHER2 Frequently Asked Questions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          ARCHER2 Frequently Asked Questions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        General FAQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/upgrade-2023/" class="md-nav__link">
        ARCHER2 Upgrade 2023
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          User and Best Practice Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          User and Best Practice Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        Hardware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../connecting/" class="md-nav__link">
        Connecting to ARCHER2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Data management and transfer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sw-environment/" class="md-nav__link">
        Software environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scheduler/" class="md-nav__link">
        Running jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        I/O and file systems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dev-environment/" class="md-nav__link">
        Application development environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../containers/" class="md-nav__link">
        Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        Using Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        Data analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debug/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../profile/" class="md-nav__link">
        Profiling
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Performance tuning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Performance tuning
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mpi" class="md-nav__link">
    MPI
  </a>
  
    <nav class="md-nav" aria-label="MPI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpi-environment-variables" class="md-nav__link">
    MPI environment variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous-communications" class="md-nav__link">
    Synchronous vs asynchronous communications
  </a>
  
    <nav class="md-nav" aria-label="Synchronous vs asynchronous communications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpi_send" class="md-nav__link">
    MPI_Send
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implications" class="md-nav__link">
    Implications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tuning-performance" class="md-nav__link">
    Tuning performance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-the-eager-limit-on-archer2" class="md-nav__link">
    Setting the eager limit on ARCHER2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collective-operations" class="md-nav__link">
    Collective operations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openmp" class="md-nav__link">
    OpenMP
  </a>
  
    <nav class="md-nav" aria-label="OpenMP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequential-code" class="md-nav__link">
    Sequential code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idle-threads" class="md-nav__link">
    Idle threads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronisation" class="md-nav__link">
    Synchronisation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduling" class="md-nav__link">
    Scheduling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communication" class="md-nav__link">
    Communication
  </a>
  
    <nav class="md-nav" aria-label="Communication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#numa-effects" class="md-nav__link">
    NUMA effects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#false-sharing" class="md-nav__link">
    False sharing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-resource-contention" class="md-nav__link">
    Hardware resource contention
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compiler-non-optimisation" class="md-nav__link">
    Compiler non-optimisation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hybrid-mpi-and-openmp" class="md-nav__link">
    Hybrid MPI and OpenMP
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../energy/" class="md-nav__link">
        Energy use
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Research Software
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Research Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/casino/" class="md-nav__link">
        CASINO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/castep/" class="md-nav__link">
        CASTEP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/cesm/" class="md-nav__link">
        CESM2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/chemshell/" class="md-nav__link">
        Chemshell
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/code-saturne/" class="md-nav__link">
        Code_Saturne
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/cp2k/" class="md-nav__link">
        CP2K
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/crystal/" class="md-nav__link">
        CRYSTAL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/fhi-aims/" class="md-nav__link">
        FHI-aims
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/gromacs/" class="md-nav__link">
        GROMACS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/lammps/" class="md-nav__link">
        LAMMPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/mitgcm/" class="md-nav__link">
        MITgcm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/mo-unified-model/" class="md-nav__link">
        Met Office Unified Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/namd/" class="md-nav__link">
        NAMD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/nektarplusplus/" class="md-nav__link">
        Nektar++
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/nemo/" class="md-nav__link">
        NEMO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/nwchem/" class="md-nav__link">
        NWChem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/onetep/" class="md-nav__link">
        ONETEP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/openfoam/" class="md-nav__link">
        OpenFOAM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/orca/" class="md-nav__link">
        ORCA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/qe/" class="md-nav__link">
        Quantum Espresso
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../research-software/vasp/" class="md-nav__link">
        VASP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Software Libraries
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Software Libraries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/libsci/" class="md-nav__link">
        HPE Cray LibSci: BLAS, LAPACK, ScaLAPACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/fftw/" class="md-nav__link">
        FFTW
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/hdf5/" class="md-nav__link">
        HDF5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/netcdf/" class="md-nav__link">
        NetCDF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/adios/" class="md-nav__link">
        ADIOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/aocl/" class="md-nav__link">
        AOCL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/arpack/" class="md-nav__link">
        ARPACK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/boost/" class="md-nav__link">
        Boost
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/eigen/" class="md-nav__link">
        Eigen
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/glm/" class="md-nav__link">
        GLM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/hypre/" class="md-nav__link">
        HYPRE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/matio/" class="md-nav__link">
        Matio
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/mkl/" class="md-nav__link">
        Intel MKL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/mesa/" class="md-nav__link">
        MESA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/mumps/" class="md-nav__link">
        MUMPS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/petsc/" class="md-nav__link">
        PETSc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/metis/" class="md-nav__link">
        Metis/Parmetis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/scotch/" class="md-nav__link">
        Scotch/PT-Scotch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/slepc/" class="md-nav__link">
        SLEPc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/superlu/" class="md-nav__link">
        SuperLU/SuperLU_DIST
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../software-libraries/trilinos/" class="md-nav__link">
        Trilinos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Data Analysis and Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Data Analysis and Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/amd-uprof/" class="md-nav__link">
        AMD uProf
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/arm-forge/" class="md-nav__link">
        Arm Forge
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/julia/" class="md-nav__link">
        Julia
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/paraview/" class="md-nav__link">
        ParaView
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/cray-r/" class="md-nav__link">
        R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../data-tools/visidata/" class="md-nav__link">
        VisiData
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../essentials/" class="md-nav__link">
        Essential Skills
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../publish/" class="md-nav__link">
        ARCHER2 and Publications
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mpi" class="md-nav__link">
    MPI
  </a>
  
    <nav class="md-nav" aria-label="MPI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpi-environment-variables" class="md-nav__link">
    MPI environment variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronous-vs-asynchronous-communications" class="md-nav__link">
    Synchronous vs asynchronous communications
  </a>
  
    <nav class="md-nav" aria-label="Synchronous vs asynchronous communications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpi_send" class="md-nav__link">
    MPI_Send
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implications" class="md-nav__link">
    Implications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tuning-performance" class="md-nav__link">
    Tuning performance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-the-eager-limit-on-archer2" class="md-nav__link">
    Setting the eager limit on ARCHER2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collective-operations" class="md-nav__link">
    Collective operations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openmp" class="md-nav__link">
    OpenMP
  </a>
  
    <nav class="md-nav" aria-label="OpenMP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sequential-code" class="md-nav__link">
    Sequential code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idle-threads" class="md-nav__link">
    Idle threads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#synchronisation" class="md-nav__link">
    Synchronisation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduling" class="md-nav__link">
    Scheduling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communication" class="md-nav__link">
    Communication
  </a>
  
    <nav class="md-nav" aria-label="Communication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#numa-effects" class="md-nav__link">
    NUMA effects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#false-sharing" class="md-nav__link">
    False sharing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware-resource-contention" class="md-nav__link">
    Hardware resource contention
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compiler-non-optimisation" class="md-nav__link">
    Compiler non-optimisation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hybrid-mpi-and-openmp" class="md-nav__link">
    Hybrid MPI and OpenMP
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="performance-tuning">Performance tuning</h1>
<h2 id="mpi">MPI</h2>
<p>The vast majority of parallel scientific applications use the MPI
library as the main way to implement parallelism; it is used so
universally that the Cray compiler wrappers on ARCHER2 link to the
Cray MPI library by default. Unlike other clusters you may have used,
there is no choice of MPI library on ARCHER2: regardless of what
compiler you are using, your program will use Cray MPI. This is
because the Slingshot network on ARCHER2 is Cray-specific and
significant effort has been put in by Cray software engineers to
optimise the MPI performance on their Shasta systems.</p>
<p>Here we list a number of suggestions for improving the performance of
your MPI programs on ARCHER2. Although MPI programs are capable of
scaling very well due to the bespoke communications hardware and
software, the details of how a program calls MPI can have significant
effects on achieved performance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Many of these tips are actually quite generic and should be beneficial
to any MPI program; however, they all become much more important when
running on very large numbers of processes on a machine the size of
ARCHER2.</p>
</div>
<h3 id="mpi-environment-variables">MPI environment variables</h3>
<p>There are a number of environment variables available to control aspects of MPI behavour on ARCHER2,
the set of options can be displayed by running,</p>
<p><div class="highlight"><pre><span></span><code>man intro_mpi
</code></pre></div>
o
n the ARCHER2 login nodes. </p>
<p>A couple of specific variables to highlight are MPICH_OFI_STARTUP_CONNECT and MPICH_OFI_RMA_STARTUP_CONNECT.</p>
<p>When using the default OFI transport layer the connections between ranks are set-up as they are required. This allows for good performance while reducing memory requirements. However for jobs using all-to-all communication it might be better to generate these connections in a coordinated way at the start of the application. To enable this set the following environment variable:</p>
<div class="highlight"><pre><span></span><code>  export MPICH_OFI_STARTUP_CONNECT=1  
</code></pre></div>
<p>Additionally, RMA jobs requiring an all-to-all communication pattern on node it may be beneficial to set up the connections between processes on a node in a coordinated fashion:</p>
<div class="highlight"><pre><span></span><code>  export MPICH_OFI_RMA_STARTUP_CONNECT=1
</code></pre></div>
<p>This option automatically enables MPICH_OFI_STARTUP_CONNECT.</p>
<h3 id="synchronous-vs-asynchronous-communications">Synchronous vs asynchronous communications</h3>
<h4 id="mpi_send">MPI_Send</h4>
<p>A standard way to send data in MPI is using <code>MPI_Send</code> (aptly called
<em>standard send</em>). Somewhat confusingly, MPI is allowed to choose how to
implement this in two different ways:</p>
<ul>
<li>
<p>Synchronously<br />
    The sending process waits until a matching receive has been posted,
    i.e. it operates like <code>MPI_Ssend</code>. This clearly has the risk of
    deadlock if no receive is ever issued.</p>
</li>
<li>
<p>Asynchronously<br />
    MPI makes a copy of the message into an internal buffer and returns
    straight away without waiting for a matching receive; the message
    may actually be delivered later on. This is like the behaviour of
    the the buffered send routine <code>MPI_Bsend</code>.</p>
</li>
</ul>
<p>The rationale is that MPI, rather than the user, should decide how best
to send a message.</p>
<p>In practice, what typically happens is that MPI tries to use an
asynchronous approach via the <em>eager</em> protocol: the message is sent
directly to a preallocated buffer <em>on the receiver</em> and the routine
returns immediately afterwards. Clearly there is a limit on how much
space can be reserved for this, so:</p>
<ul>
<li><strong>small messages</strong> will be sent asynchronously;</li>
<li><strong>large messages</strong> will be sent synchronously.</li>
</ul>
<p>The threshold is often termed the <em>eager limit</em> which is fixed for the
entire run of your program. It will have some default setting which
varies from system to system, but might be around 8K bytes.</p>
<h4 id="implications">Implications</h4>
<ul>
<li>An MPI program will typically run <em>faster</em> if <code>MPI_Send</code> is
    implemented asynchronously using the eager protocol since
    synchronisation between sender and receive is much reduced.</li>
<li>However, you should <strong>never assume</strong> that <code>MPI_Send</code> buffers your
    message, so if you have concerns about deadlock you will need to use
    the non-blocking variant <code>MPI_Isend</code> to guarantee that the send
    routine returns control to you immediately even if there is no
    matching receive.</li>
<li>It is <strong>not enough</strong> to say <em>deadlock is an issue in principle, but
    it runs OK on my laptop so there is no problem in practice</em>. The
    <em>eager limit</em> is system-dependent so the fact that a message happens
    to be buffered on your laptop is no guarantee it will be buffered on
    ARCHER2.</li>
<li>To check that you have a correct code, replace all instances of
    <code>MPI_Send</code> / <code>MPI_Isend</code> with <code>MPI_Ssend</code> / <code>MPI_Issend</code>. A correct
    MPI program should still run correctly when all references to
    standard send are replaced by synchronous send (since MPI is allowed
    to implement standard send as synchronous send).</li>
</ul>
<h4 id="tuning-performance">Tuning performance</h4>
<p>With most MPI libraries you should be able to alter the default value of
the eager limit at runtime, perhaps via an environment variable or a
command-line argument to <code>mpirun</code>.</p>
<p>The advice for tuning the performance of <code>MPI_Send</code> is</p>
<ul>
<li>find out what the distribution of message sizes for <code>MPI_Send</code> is (a
    profiling tool may be useful here);</li>
<li>this applies to <code>MPI_Isend</code> as well: even in the non-blocking form,
    which can help to weaken synchronisation between sender and
    receiver, the amount of hand-shaking required is much reduced if the
    eager protocol is used;</li>
<li>find out from the system documentation how to alter the value of the
    eager limit (there is no standardised way to set it);</li>
<li>set the eager limit to a value larger than your typical message size
    -- you may need to add a small amount, say a few hundred bytes, to
    allow for any additional header information that is added to each
    message;</li>
<li>measure the performance before and after to check that it has
    improved.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It cannot be stressed strongly enough that although the performance may
be affected by the value of the eager limit, the functionality of your
program should be unaffected. If changing the eager limit affects the
correctness of your program (e.g. whether or not it deadlocks) then
<strong>you have an incorrect MPI program</strong>.</p>
</div>
<h4 id="setting-the-eager-limit-on-archer2">Setting the eager limit on ARCHER2</h4>
<p>On ARCHER2, things are a little more complicated. Although the eager
limit defaults to 16KiB, messages up to 256KiB are sent
asynchronously because they are actually sent as a number of smaller
messages.</p>
<p>To send even larger messages asynchronously, alter the value of
<code>FI_OFI_RXM_SAR_LIMIT</code> in your job submission script, e.g. to set to 512KiB:</p>
<pre><code>export FI_OFI_RXM_SAR_LIMIT=524288
</code></pre>
<p>You can also control the size of the smaller messages by altering the value
of <code>FI_OFI_RXM_BUFFER_SIZE</code>
in your job submission script, e.g. to set to 128KiB:</p>
<pre><code>export FI_OFI_RXM_BUFFER_SIZE=131072
</code></pre>
<p>A different protocol is used for messages between two processes on the
same node. The default eager limit for these is 8K. Although the
performance of on-node messages is unlikely to be a limiting factor
for your program you can change this value, e.g. to set to 16KiB:</p>
<pre><code>export MPICH_SMP_SINGLE_COPY_SIZE=16384
</code></pre>
<h3 id="collective-operations">Collective operations</h3>
<p>Many of the collective operations that are commonly required by parallel
scientific programs, i.e. operations that involve a group of processes,
are already implemented in MPI. The canonical operation is perhaps
adding up a double precision number across all MPI processes, which is
best achieved by a <em>reduction operation</em>:</p>
<pre><code>MPI_Allreduce(&amp;x, &amp;xsum, 1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
</code></pre>
<p>This will be implemented using an efficient algorithm, for example based
on a binary tree. Using such <em>divide-and-conquer</em> approaches typically
results in an algorithm whose execution time on <em>P</em> processes scales
as <em>log_2(P)</em>; compare this to a naive approach where every process
sends its input to rank 0 where the time will scale as <em>P</em>. This might
not be significant on your laptop, but even on as few as 1000 processes
the tree-based algorithm will already be around 100 times faster.</p>
<p>So, the basic advice is <strong>always use a collective routine to implement
your communications pattern</strong> if at all possible.</p>
<p>In real MPI applications, collective operations are often called on a
small amount of data, for example a global reduction of a single
variable. In these cases, the time taken will be dominated by message
latency and the first port of call when looking at performance
optimisation is to call them as infrequently as possible!</p>
<ul>
<li>If you are simply printing diagnostics to the screen in an iterative
    loop, consider doing this less frequently, e.g every ten iterations,
    or even not at all (although you should easily be able to turn
    diagnostics on again for future debugging).</li>
<li>If you are computing some termination criterion, it may actually be
    faster overall to compute it and check for convergence infrequently,
    e.g. every ten iterations, even although this means that your
    program could run for up to 9 extra iterations.</li>
<li>If possible, group data into a single buffer and call a single
    reduction with count > 1; two reductions with count = 1 will take
    almost exactly twice as long as a single reduction with count = 2.</li>
<li>For example, if you only need to output a sequence of summed data at
    the end of the run, store the partial totals in an array and do a
    single reduction right at the end.</li>
</ul>
<p>Sometimes, the collective routines available may not appear to do
exactly what you want. However, they can sometimes be used with a small
amount of additional programming work:</p>
<ul>
<li>
<p>To operate on a subset of processes, create sub-communicators
    containing the relevant subset(s) and use these communicators
    instead of <code>MPI_COMM_WORLD</code>. Useful functions for communicator
    management include:</p>
<ul>
<li><code>MPI_Comm_split</code> is the most general routine;</li>
<li><code>MPI_Comm_split_type</code> can be used to create a separate
    communicator for each shared-memory node with <code>split type =
    MPI_COMM_TYPE_SHARED</code>;</li>
<li><code>MPI_Cart_sub</code> can divide a Cartesian communicator into regular
    slices.</li>
</ul>
</li>
<li>
<p>If the communication <em>pattern</em> is what you want, but the data on
    each process is not arranged in the required layout, consider using
    MPI derived data types for the input and/or output. This can be
    useful, for example, if you want to communicate non-contiguous data
    such as a subsection of a multidimensional array although care must
    be taken in defining these types to ensure they have the correct
    extents.</p>
<p>Another example would be using <code>MPI_Allreduce</code> to add up an integer
and a double-precision variable using a single call by putting them
together into a C <code>struct</code> and defining a matching MPI datatype
using <code>MPI_Type_create_struct</code>. Here you would also have to provide
MPI with a custom reduction operation using <code>MPI_Op_create</code>.</p>
</li>
</ul>
<p>Many MPI programs call <code>MPI_Barrier</code> to explicitly synchronise all the
processes. Although this can be useful for getting reliable performance
timings, it is rare in practice to find a program where the call is
actually needed for correctness. For example, you may see:</p>
<pre><code>// Ensure the input x is available on all processes
MPI_Barrier(MPI_COMM_WORLD);
// Perform a global reduction operation
MPI_Allreduce(&amp;x, &amp;xsum, 1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD);
// Ensure the result xsum is available on all processes
MPI_Barrier(MPI_COMM_WORLD);
</code></pre>
<p><strong>Neither of these barriers are needed</strong> as the reduction operation
performs all the required synchronisation.</p>
<p>If removing a barrier from your MPI code makes it run incorrectly, then
this should ring alarm bells -- it is often a symptom of an underlying
bug that is simply being masked by the barrier.</p>
<p>For example, if you use non-blocking calls such as <code>MPI_Irecv</code> then it
is the programmer's responsibility to ensure that these are completed at
some later point, for example by calling <code>MPI_Wait</code> on the returned
request object. A common bug is to forget to do this, in which case you
might be reading the contents of the receive buffer before the incoming
message has arrived (e.g. if the sender is running late).</p>
<p>Calling a barrier may mask this bug as it will make all the processes
wait for each other, perhaps allowing the late sender to catch up.
However, this is not guaranteed so the real solution is to call the
non-blocking communications correctly.</p>
<p>One of the few times when a barrier may be required is if processes are
communicating with each other via some other non-MPI method, e.g. via
the file system. If you want processes to sequentially open, append to,
then close the same file then barriers are a simple way to achieve this:</p>
<pre><code>for (i=0; i &lt; size; i++)
{
  if (rank == i) append_data_to_file(data, filename);
  MPI_Barrier(comm);
}
</code></pre>
<p>but this is really something of a special case.</p>
<p>Global synchronisation may be required if you are using more advanced
techniques such as hybrid MPI/OpenMP or single-sided MPI communication
with put and get, but typically you should be using specialised routines
such as <code>MPI_Win_fence</code> rather than <code>MPI_Barrier</code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you run a performance profiler on your code and it shows a lot of
time being spent in a collective operation such as <code>MPI_Allreduce</code>, this
is <em>not necessarily</em> a sign that the reduction operation itself is the
bottleneck. This is often a symptom of <em>load imbalance</em>: even if a
reduction operation is efficiently implemented, it may take a long time
to complete if the MPI processes do not all call it at the same time.
<code>MPI_Allreduce</code> synchronises across processes so will have to wait for
all the processes to call it before it can complete. A single slow
process will therefore adversely impact the performance of your entire
parallel program.</p>
</div>
<h2 id="openmp">OpenMP</h2>
<p>There are a variety of possible issues that can result in poor performance of OpenMP programs. These include:</p>
<h3 id="sequential-code">Sequential code</h3>
<p>Code outside of parallel regions is executed sequentially by the master thread.</p>
<h3 id="idle-threads">Idle threads</h3>
<p>If different threads have different amounts of computation to do, then
threads may be idle whenever a barrier is encountered, for example at
the end of parallel regions or the end of worksharing loops. For
worksharing loops, choosing a suitable schedule kind may help. For
more irregular computation patterns, using OpenMP tasks might offer a
solution: the runtime will try to load balance tasks across the
threads in the team.</p>
<p>Synchronisation mechanisms that enforce mutual exclusion, such as
critical regions, atomic statements and locks can also result in idle
threads if there is contention - threads have to wait their turn for
access.</p>
<h3 id="synchronisation">Synchronisation</h3>
<p>The act of synchronising threads comes at some cost, even if the
threads are never idle. In OpenMP, the most common source of
synchronisation overheads is the implicit barriers at the end of
parallel regions and worksharing loops. The overhead of these barriers
depends on the OpenMP implementation being used as well as on the
number of threads, but is typically in the range of a few
microseconds. This means that for a simple parallel loop such as</p>
<pre><code>#pragma omp parallel for reduction(+:sum)
for (i=0;i&lt;n;i++){
   sum += a[i];
}
</code></pre>
<p>the number of iterations required to make parallel execution
worthwhile may be of the order of 100,000. On ARCHER2, benchmarking
has shown that for the AOCC compiler, OpenMP barriers have
significantly higher overhead than for either the Cray or GNU
compilers.</p>
<p>It is possible to suppress the implicit barrier at the end of
worksharing loop using a <code>nowait</code> clause, taking care that this does
not introduce and race conditions.</p>
<p>Atomic statements are designed to be capable of more efficient
implementation that the equivalent critical region or lock/unlock pair,
so should be used where applicable.</p>
<h3 id="scheduling">Scheduling</h3>
<p>Whenever we rely on the OpenMP runtime to dynamically assign
computation to threads (e.g. dynamic or guided loop schedules, tasks),
there is some overhead incurred (some of this cost may actually be
internal synchronisation in the runtime).  It is often necessary to
adjust the granularity of the computation to find a compromise between
too many small units (and high scheduling cost) and too few large
units (where load imbalance may dominate). For example, we can choose
a non-default chunksize for the dynamic schedule, or adjust the amount of
computation within each OpenMP task construct.</p>
<h3 id="communication">Communication</h3>
<p>Communication between threads in OpenMP takes place via the cache
coherency mechanism. In brief, whenever a thread writes a memory
location, all copies of this location which are in a cache belonging
to a different core have to be marked as invalid. Subsequent accesses
to this location by other threads will result in the up-to-date value
being retrieved from the cache where the last write occurred (or
possibly from main memory).</p>
<p>Due to the fine granularity of memory accesses, these overheads are
difficult to analyse or monitor. To minimise communication, we need to
write code with good data affinity - i.e. each thread should access
the same subset of program data as much as possible.</p>
<h4 id="numa-effects">NUMA effects</h4>
<p>On modern CPU nodes, main memory is often organised in NUMA regions -
sections of main memory associated with a subset of the cores on a
node. On ARCHER2 nodes, there are 8 NUMA regions per node, each
associated with 16 CPU cores. On such systems the location of data in
main memory with respect to the cores that are accessing it can be
important. The default OS policy is to place data in the NUMA region
which first accesses it (first touch policy).  For OpenMP programs
this can be the worst possible option: if the data is initialised by
the master thread, it is all allocated one NUMA region and having all
threads accessing data becomes a bandwidth bottleneck.</p>
<p>This default policy can be changed using the <code>numactl</code> command, but it
is probably better to make use of the first touch policy by explicitly
parallelising the data initialisation in the application code. This
may be straightforward for large multidimensional arrays, but more
challenging for irregular data structures.</p>
<h4 id="false-sharing">False sharing</h4>
<p>The cache coherency mechanism described above operates on units of
data corresponding to the size of cache lines - for ARCHER2 CPUs this
is 64 bytes. This means that if different threads are accessing
neighbouring words in memory, and at least some of the accesses are
writes, then communication may be happening even if no individual word
is actually being accessed by more than one thread. This means that
patterns such as</p>
<pre><code>#pragma omp parallel shared(count) private(myid) 
{
  myid = omp_get_thread_num();
  ....
  count[myid]++;
  ....
}
</code></pre>
<p>may give poor performance if the updates to the <code>count</code> array are
sufficiently frequent.</p>
<h3 id="hardware-resource-contention">Hardware resource contention</h3>
<p>Whenever there are multiple threads (or processes) executing inside a
node, they may contend for some hardware resources. The most important
of these for many HPC applications is memory bandwidth. This is effect
is very evident on ARCHER2 CPUs - it is possible for just 2 threads to
almost saturate the available memory bandwidth in a NUMA region which
has 16 cores associated with it. For very bandwidth-intensive
applications, running more that 2 threads per NUMA region may gain
little additional performance. If an OpenMP code is not using all the
cores on a node, by default Slurm will spread the threads out across
NUMA regions to maximise the available bandwidth.</p>
<p>Another resource that threads may contend for is space in shared
caches. On ARCHER2, every set of 4 cores shares 16MB of L3 cache. </p>
<h3 id="compiler-non-optimisation">Compiler non-optimisation</h3>
<p>In rare cases, adding OpenMP directives can adversely affect the
compiler's optimisation process. The symptom of this is that the
OpenMP code running on 1 thread is slower than the same code compiled
without the OpenMP flag. It can be difficult to find a workaround -
using the compiler's diagnostic flags to find out which optimisation
(e.g. vectorisation, loop unrolling) is being affected and adding
compiler-specific directives may help.</p>
<h2 id="hybrid-mpi-and-openmp">Hybrid MPI and OpenMP</h2>
<p>There are two main motivations for using both MPI and OpenMP in the
same application code: reducing memory requirements and improving
performance. At low core counts, where the pure MPI version of the
code is still scaling well, adding OpenMP is unlikely to improve
performance. In fact, it can introduce some additional overheads which
make performance worse! The benefit is likely to come in the regime
where the pure MPI version starts to lose scalability - here adding
OpenMP can reduce communication costs, make load balancing easier, or
be an effective way of exploiting additional parallelism without
excessive code re-writing.</p>
<p>An important performance consideration for MPI + OpenMP applications
is the choice of the number of OpenMP threads per MPI process. The
optimum value will depend on the application, the input data, the
number of nodes requested and the choice of compiler, and is hard to
predict without experimentation. However, there are some
considerations that apply to ARCHER2:</p>
<ul>
<li>
<p>Due to NUMA effects, it is likely that running at least one MPI
  process per NUMA region (i.e. at least 8 MPI processes per node) will 
  be beneficial.</p>
</li>
<li>
<p>The number of MPI processes per node should be a power of 2, so that
  all OpenMP threads run in the same NUMA region as their parent
  MPI process.</p>
</li>
<li>
<p>For applications where each process has a small memory footprint
  (e.g. some molecular dynamics codes), running no more than 4 OpenMP
  threads per MPI process may be beneficial, so that all the threads
  in a process share a single L3 cache.</p>
</li>
</ul>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ARCHER2-HPC" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/ARCHER2_HPC" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/groups/13848871/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>